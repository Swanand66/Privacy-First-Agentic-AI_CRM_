<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luxury Automotive Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(to bottom, #1f2937, #ffffff);
      color: #ffffff;
      font-family: 'Poppins', sans-serif;
      line-height: 1.6;
    }

    .header {
      background: #1f2937;
      color: #ffffff;
      border-bottom: 1px solid #374151;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .brand {
      font-size: 24px;
      font-weight: 700;
      color: #ffffff;
    }

    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .header-controls input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #ffffff;
      color: #374151;
      font-size: 14px;
    }

    .refresh-btn {
      padding: 8px 16px;
      background: #10b981;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .refresh-btn:hover {
      background: #059669;
    }

    .container {
      padding: 30px 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: #1f2937;
      color: #ffffff;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .metric-label {
      font-size: 14px;
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 8px;
    }

    .metric-change {
      font-size: 12px;
      color: #10b981;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .panel {
      background: #1f2937;
      color: #ffffff;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .panel-title-section {
      flex: 1;
    }

    .panel-title {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 8px;
    }

    .chart-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .chart-selector {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #ffffff;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      min-width: 160px;
    }

    .chart-selector:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .chart-selector:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .chart-selector option {
      background: #1f2937;
      color: #ffffff;
      padding: 8px;
    }

    .panel-subtitle {
      font-size: 14px;
      color: #e5e7eb;
      margin-bottom: 20px;
    }

    .pipeline-chart {
      height: 300px;
      background: #1f2937;
      border-radius: 6px;
      padding: 20px;
    }

    .chart-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #pipelineCanvas {
      max-width: 100%;
      max-height: 100%;
    }

    .circular-progress {
      width: 120px;
      height: 120px;
      margin: 20px auto;
      position: relative;
    }

    .circle-bg {
      fill: none;
      stroke: #e5e7eb;
      stroke-width: 8;
    }

    .circle-progress {
      fill: none;
      stroke: #3b82f6;
      stroke-width: 8;
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .progress-value {
      font-size: 24px;
      font-weight: 700;
      color: #ffffff;
    }

    .progress-label {
      font-size: 12px;
      color: #e5e7eb;
    }

    .status-list {
      margin-top: 20px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #374151;
    }

    .status-item:last-child {
      border-bottom: none;
    }

    .status-label {
      font-size: 14px;
      color: #ffffff;
    }

    .status-percent {
      font-size: 16px;
      font-weight: 600;
      color: #ffffff;
    }

    .vehicle-types {
      margin-top: 20px;
    }

    .vehicle-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #374151;
    }

    .vehicle-item:last-child {
      border-bottom: none;
    }

    .vehicle-name {
      font-size: 14px;
      color: #ffffff;
    }

    .vehicle-bar {
      width: 100px;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }

    .vehicle-fill {
      height: 100%;
      background: #3b82f6;
      border-radius: 4px;
      transition: width 1s ease-out;
    }

    .vehicle-percent {
      font-size: 14px;
      font-weight: 600;
      color: #ffffff;
      min-width: 40px;
      text-align: right;
    }

    .kanban-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 16px;
      margin-top: 20px;
    }

    .kanban-column {
      background: #1f2937; /* Darker background for clarity */
      color: #ffffff;
      border: 1px solid #374151;
      border-radius: 6px;
      padding: 16px;
      min-height: 300px;
    }

    .kanban-header {
      font-size: 12px;
      font-weight: 600;
      color: #e5e7eb;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .kanban-header span {
      color: #ffffff; /* Ensure numbers are visible in white */
    }

    .kanban-count {
      background: #e5e7eb;
      color: #374151;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
    }

    .lead-card {
      background: #374151; /* Slightly lighter background for cards */
      color: #ffffff;
      border: 1px solid #374151;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }

    .lead-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 4px rgba(59,130,246,0.1);
    }

    .lead-actions {
      margin-top: 8px;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 4px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: #10b981;
      color: #ffffff;
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: #059669;
    }

    .action-btn.hold { border-color: #f59e0b; color: #f59e0b; }
    .action-btn.qualify { border-color: #3b82f6; color: #3b82f6; }
    .action-btn.opportunity { border-color: #8b5cf6; color: #8b5cf6; }
    .action-btn.close-won {
      background: #10b981; /* Green for "Won" clarity */
      color: #ffffff;
      border-color: #10b981;
    }
    .action-btn.close-lost { border-color: #ef4444; color: #ef4444; }

    .lead-name {
      font-weight: 600;
      font-size: 13px;
      color: #ffffff;
      margin-bottom: 4px;
    }

    .lead-vehicle {
      font-size: 11px;
      color: #e5e7eb;
      margin-bottom: 6px;
    }

    .lead-badges {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 500;
    }

    .badge-hot { background: #dc2626; color: #ffffff; }
    .badge-vip { background: #2563eb; color: #ffffff; }
    .badge-cold { background: #6b7280; color: #ffffff; }
    .badge-warm { background: #d97706; color: #ffffff; }

    .loading {
      color: #6b7280;
      font-style: italic;
    }

    .error {
      color: #dc2626;
      font-style: italic;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      margin: 5% auto;
      padding: 0;
      border: 1px solid #444;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      background: linear-gradient(135deg, #1d4ed8, #3b82f6);
      padding: 20px;
      border-radius: 16px 16px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      color: white;
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }

    .close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .close:hover {
      opacity: 0.7;
    }

    .modal-body {
      padding: 30px;
      color: #e0e0e0;
    }

    .lead-detail-section {
      margin-bottom: 25px;
    }

    .lead-detail-section h3 {
      background: linear-gradient(135deg, #3b82f6, #ffffff);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 15px;
      font-size: 18px;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 8px;
    }

    .detail-row {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 15px;
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    .detail-label {
      font-weight: 600;
      color: #a0a0a0;
    }

    .detail-value {
      color: #ffffff;
    }

    /* Drag and Drop Styles */
    .lead-card {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .lead-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .lead-card.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }

    .kanban-column.drag-over {
      background-color: rgba(59, 130, 246, 0.1);
      border: 2px dashed #3b82f6;
    }

    /* Search and Filter Panel */
    .search-filter-panel {
      background: rgba(31, 41, 55, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(75, 85, 99, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .search-section {
      display: flex;
      justify-content: center;
    }

    .search-box {
      position: relative;
      width: 100%;
      max-width: 500px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 40px 12px 16px;
      background: rgba(17, 24, 39, 0.8);
      border: 2px solid rgba(75, 85, 99, 0.4);
      border-radius: 25px;
      font-size: 16px;
      color: #ffffff;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .search-box input::placeholder {
      color: rgba(156, 163, 175, 0.8);
    }

    .search-box input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      background: rgba(17, 24, 39, 0.95);
    }

    .clear-search {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: rgba(156, 163, 175, 0.8);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .clear-search:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .filter-section {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }

    .filter-section select {
      padding: 8px 12px;
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid rgba(75, 85, 99, 0.4);
      border-radius: 8px;
      color: #ffffff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .filter-section select option {
      background: #1f2937;
      color: #ffffff;
    }

    .filter-section select:focus {
      outline: none;
      border-color: #3b82f6;
      background: rgba(17, 24, 39, 0.95);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .reset-filters {
      padding: 8px 16px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .reset-filters:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-1px);
    }

    /* Theme Toggle Button */
    .theme-toggle {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #ffffff;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 16px;
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    /* Light Mode Styles */
    body.light-mode {
      background: linear-gradient(to bottom, #f8fafc, #e2e8f0);
      color: #1f2937;
    }

    body.light-mode .header {
      background: rgba(255, 255, 255, 0.95);
      color: #1f2937;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    body.light-mode .brand {
      color: #1f2937;
      font-weight: 700;
    }

    body.light-mode .metric-card {
      background: rgba(255, 255, 255, 0.95);
      color: #1f2937;
      border: 1px solid rgba(0, 0, 0, 0.15);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    body.light-mode .metric-label {
      color: #6b7280;
      font-weight: 600;
    }

    body.light-mode .metric-value {
      color: #1f2937;
      font-weight: 700;
    }

    body.light-mode .metric-change {
      color: #059669;
      background: #ecfdf5;
    }

    body.light-mode .panel {
      background: rgba(255, 255, 255, 0.95);
      color: #1f2937;
      border: 1px solid rgba(0, 0, 0, 0.15);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    body.light-mode .panel-title {
      color: #1f2937;
      font-weight: 600;
    }

    body.light-mode .panel-subtitle {
      color: #6b7280;
    }

    body.light-mode .chart-selector {
      background: rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.2);
      color: #1f2937;
    }

    body.light-mode .chart-selector:hover {
      background: rgba(0, 0, 0, 0.1);
      border-color: rgba(0, 0, 0, 0.3);
    }

    body.light-mode .chart-selector:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    body.light-mode .chart-selector option {
      background: #ffffff;
      color: #1f2937;
    }

    body.light-mode .kanban-column {
      background: #f9fafb !important;
      color: #1f2937 !important;
      border: 2px solid #e5e7eb !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1) !important;
      min-height: 400px !important;
      padding: 16px !important;
      border-radius: 8px !important;
    }

    body.light-mode .kanban-header {
      color: #374151;
      font-weight: 600;
    }

    body.light-mode .kanban-count {
      background: #e5e7eb;
      color: #374151;
    }

    body.light-mode .lead-card {
      background: #ffffff !important;
      color: #1f2937 !important;
      border: 2px solid #d1d5db !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
      margin-bottom: 12px !important;
      padding: 12px !important;
      border-radius: 8px !important;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    body.light-mode .lead-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25) !important;
      border-color: #3b82f6 !important;
    }

    body.light-mode .lead-name {
      color: #1f2937 !important;
      font-weight: 600 !important;
      font-size: 14px !important;
      margin-bottom: 4px !important;
    }

    body.light-mode .lead-vehicle {
      color: #6b7280 !important;
      font-size: 12px !important;
      margin-bottom: 8px !important;
    }

    body.light-mode .lead-badges {
      display: flex !important;
      gap: 6px !important;
      flex-wrap: wrap !important;
      margin-bottom: 8px !important;
    }

    body.light-mode .badge {
      font-size: 10px !important;
      padding: 2px 6px !important;
      border-radius: 4px !important;
      font-weight: 500 !important;
      color: white !important;
    }

    body.light-mode .lead-actions {
      display: flex !important;
      gap: 4px !important;
      flex-wrap: wrap !important;
    }

    body.light-mode .search-filter-panel {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(0, 0, 0, 0.15);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    body.light-mode .search-box input {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(0, 0, 0, 0.1);
      color: #1f2937;
    }

    body.light-mode .search-box input::placeholder {
      color: rgba(107, 114, 128, 0.8);
    }

    body.light-mode .search-box input:focus {
      background: rgba(255, 255, 255, 1);
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    body.light-mode .filter-section select {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.15);
      color: #1f2937;
    }

    body.light-mode .filter-section select option {
      background: #ffffff;
      color: #1f2937;
    }

    body.light-mode .filter-section select:focus {
      background: rgba(255, 255, 255, 1);
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    body.light-mode .clear-search {
      color: rgba(107, 114, 128, 0.8);
    }

    body.light-mode .clear-search:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    body.light-mode .theme-toggle {
      background: rgba(0, 0, 0, 0.1);
      color: #1f2937;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    body.light-mode .theme-toggle:hover {
      background: rgba(0, 0, 0, 0.15);
    }

    body.light-mode .refresh-btn {
      background: #3b82f6;
      color: white;
      border: none;
    }

    body.light-mode .refresh-btn:hover {
      background: #2563eb;
    }

    /* Light mode input styles */
    body.light-mode .header-controls input {
      background: rgba(255, 255, 255, 0.9);
      color: #1f2937;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    body.light-mode .header-controls input:focus {
      border-color: #3b82f6;
      background: rgba(255, 255, 255, 1);
    }

    /* Light mode action buttons */
    body.light-mode .action-btn {
      color: white;
      font-weight: 500;
    }

    body.light-mode .action-btn.qualify {
      background: #3b82f6;
    }

    body.light-mode .action-btn.opportunity {
      background: #f59e0b;
    }

    body.light-mode .action-btn.close-won {
      background: #10b981;
    }

    body.light-mode .action-btn.close-lost {
      background: #ef4444;
    }

    body.light-mode .action-btn.hold {
      background: #6b7280;
    }

    /* Light mode vehicle portfolio styles */
    body.light-mode .vehicle-types {
      display: flex !important;
      flex-direction: column !important;
      gap: 12px !important;
    }

    body.light-mode .vehicle-item {
      display: flex !important;
      align-items: center !important;
      justify-content: space-between !important;
      padding: 12px !important;
      background: rgba(255, 255, 255, 0.8) !important;
      border: 1px solid #e5e7eb !important;
      border-radius: 8px !important;
      color: #1f2937 !important;
    }

    body.light-mode .vehicle-name {
      font-weight: 600 !important;
      color: #1f2937 !important;
      font-size: 14px !important;
      min-width: 120px !important;
    }

    body.light-mode .vehicle-bar {
      flex: 1 !important;
      height: 8px !important;
      background: #e5e7eb !important;
      border-radius: 4px !important;
      margin: 0 12px !important;
      overflow: hidden !important;
    }

    body.light-mode .vehicle-fill {
      height: 100% !important;
      background: linear-gradient(90deg, #3b82f6, #1d4ed8) !important;
      border-radius: 4px !important;
      transition: width 1s ease-out !important;
    }

    body.light-mode .vehicle-percent {
      font-size: 14px !important;
      font-weight: 600 !important;
      color: #1f2937 !important;
      min-width: 40px !important;
      text-align: right !important;
    }

    /* Light mode circular progress styles */
    body.light-mode .circular-progress {
      width: 120px !important;
      height: 120px !important;
      margin: 20px auto !important;
      position: relative !important;
    }

    body.light-mode .circular-progress svg {
      display: block !important;
      width: 120px !important;
      height: 120px !important;
    }

    body.light-mode .circular-progress circle {
      stroke: #3b82f6 !important;
    }

    body.light-mode .circle-bg {
      stroke: #e5e7eb !important;
    }

    body.light-mode .progress-text {
      position: absolute !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      text-align: center !important;
      color: #1f2937 !important;
      font-weight: 600 !important;
    }

    body.light-mode .progress-value {
      color: #1f2937 !important;
      font-weight: 700 !important;
      font-size: 24px !important;
    }

    body.light-mode .progress-label {
      color: #374151 !important;
      font-weight: 500 !important;
      font-size: 12px !important;
    }

    body.light-mode #hotPercent {
      color: #1f2937 !important;
      font-weight: 700 !important;
      font-size: 24px !important;
      text-shadow: none !important;
    }

    body.light-mode .status-list {
      display: flex !important;
      flex-direction: column !important;
      gap: 12px !important;
      width: 100% !important;
    }

    body.light-mode .status-item {
      display: flex !important;
      align-items: center !important;
      justify-content: space-between !important;
      padding: 12px !important;
      background: rgba(255, 255, 255, 0.8) !important;
      border: 1px solid #e5e7eb !important;
      border-radius: 6px !important;
      color: #1f2937 !important;
    }

    body.light-mode .status-label {
      display: flex !important;
      align-items: center !important;
      gap: 8px !important;
      font-weight: 500 !important;
      color: #374151 !important;
    }

    body.light-mode .status-dot {
      width: 8px !important;
      height: 8px !important;
      border-radius: 50% !important;
      background: #10b981 !important;
    }

    body.light-mode .status-percent {
      font-size: 16px !important;
      font-weight: 600 !important;
      color: #1f2937 !important;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .search-filter-panel {
        padding: 16px;
      }
      
      .filter-section {
        flex-direction: column;
        gap: 8px;
      }
      
      .filter-section select {
        width: 100%;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="header">
    <div class="brand">Luxury Automotive</div>
    <div class="header-controls">
      <input id="baseUrl" value="http://localhost:5000" placeholder="API URL" />
      <input id="token" type="password" placeholder="Bearer Token" value="AJoIgBPsxE2_t6Mi7L7DOOTxuWo3iEjFe8QmP2rQ3xU" />
      <button class="refresh-btn" onclick="loadDashboard()">
        <span id="btnText">Refresh</span>
      </button>
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
        <span id="themeIcon">🌙</span>
      </button>
    </div>
  </div>

  <div class="container">
    <!-- Search and Filter Controls -->
    <div class="search-filter-panel">
      <div class="search-section">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="🔍 Search leads by name, email, or vehicle..." />
          <button class="clear-search" onclick="clearSearch()" title="Clear search">✕</button>
        </div>
      </div>
      <div class="filter-section">
        <select id="stageFilter" onchange="applyFilters()">
          <option value="">All Stages</option>
          <option value="new">New</option>
          <option value="contacted">Contacted</option>
          <option value="qualified">Qualified</option>
          <option value="opportunity">Opportunity</option>
          <option value="closed_won">Won</option>
          <option value="closed_lost">Lost</option>
        </select>
        <select id="classificationFilter" onchange="applyFilters()">
          <option value="">All Classifications</option>
          <option value="cold_lead">Cold Lead</option>
          <option value="warm_prospect">Warm Prospect</option>
          <option value="hot_lead">Hot Lead</option>
          <option value="vip_client">VIP Client</option>
        </select>
        <select id="sourceFilter" onchange="applyFilters()">
          <option value="">All Sources</option>
          <option value="Website">Website</option>
          <option value="Referral">Referral</option>
          <option value="Showroom Visit">Showroom Visit</option>
          <option value="VIP Referral">VIP Referral</option>
        </select>
        <button class="reset-filters" onclick="resetFilters()">Reset Filters</button>
      </div>
    </div>

    <!-- Hero Metrics -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">TOTAL LEADS</div>
        <div class="metric-value" id="mTotal">Loading...</div>
        <div class="metric-change">
          <span>↗</span>
          <span>+12.5% vs last month</span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-label">HOT LEADS</div>
        <div class="metric-value" id="mHot">Loading...</div>
        <div class="metric-change">
          <span>•</span>
          <span>Urgent Action Required</span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-label">CONVERSION RATE</div>
        <div class="metric-value" id="mConv">Loading...</div>
        <div class="metric-change">
          <span>↗</span>
          <span>Target: 60.0%</span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-label">PIPELINE VALUE</div>
        <div class="metric-value" id="mRev">Loading...</div>
        <div class="metric-change">
          <span></span>
          <span>₹ INR Forecast</span>
        </div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
      <!-- Sales Pipeline Distribution -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title-section">
            <div class="panel-title">Sales Pipeline Distribution</div>
            <div class="panel-subtitle">Lead flow across conversion stages</div>
          </div>
          <div class="chart-controls">
            <select id="chartTypeSelector" onchange="changeChartType()" class="chart-selector">
              <option value="bar">📊 Bar Chart</option>
              <option value="pie">🥧 Pie Chart</option>
              <option value="doughnut">🍩 Doughnut Chart</option>
              <option value="line">📈 Line Chart</option>
              <option value="area">📊 Area Chart</option>
              <option value="funnel">🔽 Funnel Chart</option>
            </select>
          </div>
        </div>
        <div class="pipeline-chart" id="pipelineChart">
          <div class="chart-container">
            <canvas id="pipelineCanvas" style="max-height: 300px;"></canvas>
          </div>
        </div>
      </div>

      <!-- Lead Quality Score -->
      <div class="panel">
        <div class="panel-title">Lead Quality Score</div>
        <div class="panel-subtitle">Hot vs Total Leads</div>
        <div class="circular-progress">
          <svg width="120" height="120">
            <circle class="circle-bg" cx="60" cy="60" r="50"></circle>
            <circle class="circle-progress" cx="60" cy="60" r="50" id="hotCircle"></circle>
          </svg>
          <div class="progress-text">
            <div class="progress-value" id="hotPercent">Loading...</div>
            <div class="progress-label">Hot Leads</div>
          </div>
        </div>
        <div class="status-list">
          <div class="status-item">
            <div class="status-label">• Qualified</div>
            <div class="status-percent" id="qualifiedCount">Loading...</div>
          </div>
          <div class="status-item">
            <div class="status-label">• Opportunity</div>
            <div class="status-percent" id="opportunityCount">Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Vehicle Types -->
    <div class="panel">
      <div class="panel-title">Luxury Vehicle Portfolio</div>
      <div class="panel-subtitle">Interest distribution by vehicle type</div>
      <div class="vehicle-types" id="vehicleTypes">
        <div class="vehicle-item">
          <div class="vehicle-name">Rolls-Royce</div>
          <div class="vehicle-bar">
            <div class="vehicle-fill" style="width: 45%;"></div>
          </div>
          <div class="vehicle-percent">45%</div>
        </div>
        <div class="vehicle-item">
          <div class="vehicle-name">Bentley</div>
          <div class="vehicle-bar">
            <div class="vehicle-fill" style="width: 30%;"></div>
          </div>
          <div class="vehicle-percent">30%</div>
        </div>
        <div class="vehicle-item">
          <div class="vehicle-name">Ferrari</div>
          <div class="vehicle-bar">
            <div class="vehicle-fill" style="width: 15%;"></div>
          </div>
          <div class="vehicle-percent">15%</div>
        </div>
        <div class="vehicle-item">
          <div class="vehicle-name">Lamborghini</div>
          <div class="vehicle-bar">
            <div class="vehicle-fill" style="width: 10%;"></div>
          </div>
          <div class="vehicle-percent">10%</div>
        </div>
      </div>
    </div>

    <!-- Executive Pipeline View -->
    <div class="panel">
      <div class="panel-title">Executive Pipeline View</div>
      <div class="panel-subtitle">Rolls-Royce, Bentley & Ultra-Luxury Opportunities</div>
      <div class="kanban-grid" id="kanban">
        <div class="kanban-column" id="new-column" data-stage="new">
          <div class="kanban-header">
            <span>NEW</span>
            <span class="kanban-count" id="new-count">0</span>
          </div>
          <div id="new-leads"></div>
        </div>
        <div class="kanban-column" id="contacted-column" data-stage="contacted">
          <div class="kanban-header">
            <span>CONTACTED</span>
            <span class="kanban-count" id="contacted-count">0</span>
          </div>
          <div id="contacted-leads"></div>
        </div>
        <div class="kanban-column" id="qualified-column" data-stage="qualified">
          <div class="kanban-header">
            <span>QUALIFIED</span>
            <span class="kanban-count" id="qualified-count">0</span>
          </div>
          <div id="qualified-leads"></div>
        </div>
        <div class="kanban-column" id="opportunity-column" data-stage="opportunity">
          <div class="kanban-header">
            <span>OPPORTUNITY</span>
            <span class="kanban-count" id="opportunity-count">0</span>
          </div>
          <div id="opportunity-leads"></div>
        </div>
        <div class="kanban-column" id="closed_won-column" data-stage="closed_won">
          <div class="kanban-header">
            <span>WON</span>
            <span class="kanban-count" id="closed_won-count">0</span>
          </div>
          <div id="closed_won-leads"></div>
        </div>
        <div class="kanban-column" id="closed_lost-column" data-stage="closed_lost">
          <div class="kanban-header">
            <span>LOST</span>
            <span class="kanban-count" id="closed_lost-count">0</span>
          </div>
          <div id="closed_lost-leads"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lead Detail Modal -->
  <div id="leadModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Lead Details</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Lead details will be populated here -->
      </div>
    </div>
  </div>

  <script>
    // Utility functions
    const $ = (id) => document.getElementById(id);
    
    function formatINR(n) {
      return '₹' + Math.round(n).toLocaleString('en-IN');
    }

    // Global variables for filtering
    let allLeadsData = [];
    let filteredLeadsData = [];

    // Search and Filter Functions
    function initializeSearchAndFilter() {
      const searchInput = $('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', debounce(applyFilters, 300));
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function applyFilters() {
      const searchTerm = $('searchInput').value.toLowerCase().trim();
      const stageFilter = $('stageFilter').value;
      const classificationFilter = $('classificationFilter').value;
      const sourceFilter = $('sourceFilter').value;

      filteredLeadsData = allLeadsData.filter(lead => {
        // Search filter
        const matchesSearch = !searchTerm || 
          (lead.name && lead.name.toLowerCase().includes(searchTerm)) ||
          (lead.email && lead.email.toLowerCase().includes(searchTerm)) ||
          (lead.interest && lead.interest.toLowerCase().includes(searchTerm)) ||
          (lead.phone && lead.phone.toLowerCase().includes(searchTerm));

        // Stage filter
        const matchesStage = !stageFilter || lead.stage === stageFilter;

        // Classification filter
        const matchesClassification = !classificationFilter || lead.classification === classificationFilter;

        // Source filter
        const matchesSource = !sourceFilter || lead.source === sourceFilter;

        return matchesSearch && matchesStage && matchesClassification && matchesSource;
      });

      // Re-render kanban with filtered data
      renderKanban(filteredLeadsData);
      updateFilteredMetrics();
    }

    function clearSearch() {
      $('searchInput').value = '';
      applyFilters();
    }

    function resetFilters() {
      $('searchInput').value = '';
      $('stageFilter').value = '';
      $('classificationFilter').value = '';
      $('sourceFilter').value = '';
      applyFilters();
    }

    function updateFilteredMetrics() {
      // Update metrics based on filtered data
      const totalFiltered = filteredLeadsData.length;
      const hotFiltered = filteredLeadsData.filter(lead => lead.classification === 'hot_lead').length;
      
      // Show filtered count if different from total
      if (totalFiltered !== allLeadsData.length) {
        $('mTotal').innerHTML = `${totalFiltered} <small style="opacity:0.7">of ${allLeadsData.length}</small>`;
        $('mHot').innerHTML = `${hotFiltered} <small style="opacity:0.7">filtered</small>`;
      }
    }

    // Dark Mode Functions
    function toggleTheme() {
      const body = document.body;
      const themeIcon = $('themeIcon');
      
      if (body.classList.contains('light-mode')) {
        // Switch to dark mode
        body.classList.remove('light-mode');
        themeIcon.textContent = '🌙';
        localStorage.setItem('theme', 'dark');
      } else {
        // Switch to light mode
        body.classList.add('light-mode');
        themeIcon.textContent = '☀️';
        localStorage.setItem('theme', 'light');
      }
    }

    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme');
      const body = document.body;
      const themeIcon = $('themeIcon');
      
      if (savedTheme === 'light') {
        body.classList.add('light-mode');
        themeIcon.textContent = '☀️';
      } else {
        body.classList.remove('light-mode');
        themeIcon.textContent = '🌙';
      }
    }

    async function fetchJSON(path) {
      const base = $('baseUrl').value.trim().replace(/\/$/, '');
      const token = $('token').value.trim();
      
      const res = await fetch(base + path, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      
      return await res.json();
    }

    function renderMetrics(data) {
      const stats = data.stats || {};
      const counts = data.pipeline_counts || {};
      const forecast = data.forecast_revenue || {};

      // Update metric values
      $('mTotal').innerText = stats.total_leads || 0;
      $('mHot').innerText = stats.classification_counts?.hot_lead || 0;
      
      // Use conversion rate from backend (won / (won + lost))
      $('mConv').innerText = (stats.conversion_rate || 0) + '%';
      
      // Use pipeline_value from backend and format as crores
      const pipelineValue = stats.pipeline_value || 0;
      $('mRev').innerText = pipelineValue > 0 ? `₹${pipelineValue} Crores` : '₹0';

      // Update circular progress
      const hotLeads = stats.classification_counts?.hot_lead || 0;
      const hotPercent = stats.total_leads > 0 ? Math.round((hotLeads / stats.total_leads) * 100) : 0;
      $('hotPercent').innerText = hotPercent + '%';
      
      // Animate circle
      const circle = $('hotCircle');
      const circumference = 2 * Math.PI * 50;
      const offset = circumference - (hotPercent / 100) * circumference;
      circle.style.strokeDasharray = circumference;
      circle.style.strokeDashoffset = offset;

      // Update status counts
      $('qualifiedCount').innerText = counts.qualified || 0;
      $('opportunityCount').innerText = counts.opportunity || 0;

      // Render pipeline chart
      renderPipelineChart(counts);
    }

    let pipelineChart;

    function renderPipelineChart(counts) {
      const canvas = document.getElementById('pipelineCanvas');
      if (!canvas) return;
      
      // Destroy existing chart
      if (pipelineChart) {
        pipelineChart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      
      // Pipeline stages data
      const labels = ['New', 'Contacted', 'Qualified', 'Opportunity', 'Won', 'Lost'];
      const data = [
        counts.new || 0,
        counts.contacted || 0, 
        counts.qualified || 0,
        counts.opportunity || 0,
        counts.closed_won || 0,
        counts.closed_lost || 0
      ];
      
      // Create gradients for each bar
      const gradients = labels.map((_, index) => {
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        const colors = [
          ['#9CA3AF', '#6B7280'], // New - Gray gradient
          ['#93C5FD', '#3B82F6'], // Contacted - Light to medium blue
          ['#60A5FA', '#2563EB'], // Qualified - Medium to dark blue  
          ['#FBBF24', '#F59E0B'], // Opportunity - Yellow gradient
          ['#34D399', '#10B981'], // Won - Green gradient
          ['#F87171', '#EF4444']  // Lost - Red gradient
        ];
        gradient.addColorStop(0, colors[index][0]);
        gradient.addColorStop(1, colors[index][1]);
        return gradient;
      });
      
      pipelineChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: gradients,
            borderColor: [
              '#6B7280', '#3B82F6', '#2563EB', 
              '#F59E0B', '#10B981', '#EF4444'
            ],
            borderWidth: 2,
            borderRadius: {
              topLeft: 8,
              topRight: 8,
              bottomLeft: 4,
              bottomRight: 4
            },
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 2000,
            easing: 'easeInOutQuart',
            delay: (context) => context.dataIndex * 200
          },
          plugins: {
            legend: { 
              display: false 
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.9)',
              titleColor: '#3B82F6',
              bodyColor: '#FFFFFF',
              borderColor: '#3B82F6',
              borderWidth: 1,
              cornerRadius: 8,
              padding: 12,
              displayColors: false,
              callbacks: {
                title: (context) => `${context[0].label} Stage`,
                label: (context) => `${context.parsed.y} leads`
              }
            }
          },
          scales: {
            x: {
              grid: { 
                display: false 
              },
              ticks: { 
                color: '#E5E7EB',
                font: {
                  family: 'Poppins',
                  size: 12,
                  weight: '500'
                }
              }
            },
            y: {
              beginAtZero: true,
              grid: { 
                color: 'rgba(229, 231, 235, 0.1)',
                drawBorder: false
              },
              ticks: { 
                color: '#E5E7EB',
                font: {
                  family: 'Poppins',
                  size: 11
                },
                precision: 0
              }
            }
          },
          onHover: (event, elements) => {
            event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
          },
          elements: {
            bar: {
              hoverBackgroundColor: function(context) {
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                const colors = [
                  ['#D1D5DB', '#9CA3AF'], // New - Lighter gray
                  ['#DBEAFE', '#93C5FD'], // Contacted - Lighter blue
                  ['#BFDBFE', '#60A5FA'], // Qualified - Lighter blue
                  ['#FEF3C7', '#FBBF24'], // Opportunity - Lighter yellow
                  ['#D1FAE5', '#34D399'], // Won - Lighter green
                  ['#FEE2E2', '#F87171']  // Lost - Lighter red
                ];
                gradient.addColorStop(0, colors[context.dataIndex][0]);
                gradient.addColorStop(1, colors[context.dataIndex][1]);
                return gradient;
              }
            }
          }
        }
      });
    }

    // Global variable to store current chart data
    let currentChartData = null;

    function changeChartType() {
      const chartType = document.getElementById('chartTypeSelector').value;
      if (currentChartData) {
        renderPipelineChartByType(currentChartData, chartType);
      }
    }

    function renderPipelineChartByType(counts, chartType = 'bar') {
      const canvas = document.getElementById('pipelineCanvas');
      if (!canvas) return;
      
      // Store data for chart type changes
      currentChartData = counts;
      
      // Destroy existing chart
      if (pipelineChart) {
        pipelineChart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      
      // Pipeline stages data
      const labels = ['New', 'Contacted', 'Qualified', 'Opportunity', 'Won', 'Lost'];
      const data = [
        counts.new || 0,
        counts.contacted || 0, 
        counts.qualified || 0,
        counts.opportunity || 0,
        counts.closed_won || 0,
        counts.closed_lost || 0
      ];

      // Color schemes for different chart types
      const colors = ['#9CA3AF', '#3B82F6', '#2563EB', '#F59E0B', '#10B981', '#EF4444'];
      const hoverColors = ['#D1D5DB', '#93C5FD', '#60A5FA', '#FBBF24', '#34D399', '#F87171'];

      let chartConfig = {
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderColor: colors,
            borderWidth: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1500,
            easing: 'easeInOutQuart'
          },
          plugins: {
            legend: { 
              display: chartType === 'pie' || chartType === 'doughnut',
              position: 'bottom',
              labels: {
                color: '#E5E7EB',
                font: { family: 'Poppins', size: 12 },
                padding: 20,
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.9)',
              titleColor: '#3B82F6',
              bodyColor: '#FFFFFF',
              borderColor: '#3B82F6',
              borderWidth: 1,
              cornerRadius: 8,
              padding: 12,
              displayColors: false,
              callbacks: {
                title: (context) => `${context[0].label} Stage`,
                label: (context) => {
                  if (chartType === 'pie' || chartType === 'doughnut') {
                    const total = data.reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                    return `${context.parsed} leads (${percentage}%)`;
                  }
                  return `${context.parsed.y || context.parsed} leads`;
                }
              }
            }
          }
        }
      };

      // Chart type specific configurations
      switch (chartType) {
        case 'bar':
          chartConfig.type = 'bar';
          chartConfig.data.datasets[0].backgroundColor = colors.map((color, index) => {
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, color);
            gradient.addColorStop(1, hoverColors[index]);
            return gradient;
          });
          chartConfig.data.datasets[0].borderRadius = {
            topLeft: 8, topRight: 8, bottomLeft: 4, bottomRight: 4
          };
          chartConfig.options.scales = {
            x: {
              grid: { display: false },
              ticks: { color: '#E5E7EB', font: { family: 'Poppins', size: 12 } }
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(229, 231, 235, 0.1)', drawBorder: false },
              ticks: { color: '#E5E7EB', font: { family: 'Poppins', size: 11 }, precision: 0 }
            }
          };
          break;

        case 'pie':
          chartConfig.type = 'pie';
          chartConfig.data.datasets[0].hoverBackgroundColor = hoverColors;
          break;

        case 'doughnut':
          chartConfig.type = 'doughnut';
          chartConfig.data.datasets[0].hoverBackgroundColor = hoverColors;
          chartConfig.options.cutout = '60%';
          break;

        case 'line':
          chartConfig.type = 'line';
          chartConfig.data.datasets[0] = {
            ...chartConfig.data.datasets[0],
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderColor: '#3B82F6',
            borderWidth: 3,
            fill: false,
            tension: 0.4,
            pointBackgroundColor: colors,
            pointBorderColor: '#FFFFFF',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8
          };
          chartConfig.options.scales = {
            x: {
              grid: { color: 'rgba(229, 231, 235, 0.1)' },
              ticks: { color: '#E5E7EB', font: { family: 'Poppins', size: 12 } }
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(229, 231, 235, 0.1)' },
              ticks: { color: '#E5E7EB', font: { family: 'Poppins', size: 11 }, precision: 0 }
            }
          };
          break;

        case 'area':
          chartConfig.type = 'line';
          chartConfig.data.datasets[0] = {
            ...chartConfig.data.datasets[0],
            backgroundColor: 'rgba(59, 130, 246, 0.3)',
            borderColor: '#3B82F6',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: colors,
            pointBorderColor: '#FFFFFF',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8
          };
          chartConfig.options.scales = {
            x: {
              grid: { color: 'rgba(229, 231, 235, 0.1)' },
              ticks: { color: '#E5E7EB', font: { family: 'Poppins', size: 12 } }
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(229, 231, 235, 0.1)' },
              ticks: { color: '#E5E7EB', font: { family: 'Poppins', size: 11 }, precision: 0 }
            }
          };
          break;

        case 'funnel':
          // Create a custom funnel chart using horizontal bar chart
          chartConfig.type = 'bar';
          chartConfig.options.indexAxis = 'y';
          chartConfig.data.datasets[0].backgroundColor = colors;
          chartConfig.data.datasets[0].borderRadius = 8;
          chartConfig.options.scales = {
            x: {
              beginAtZero: true,
              grid: { color: 'rgba(229, 231, 235, 0.1)' },
              ticks: { color: '#E5E7EB', font: { family: 'Poppins', size: 11 }, precision: 0 }
            },
            y: {
              grid: { display: false },
              ticks: { color: '#E5E7EB', font: { family: 'Poppins', size: 12 } }
            }
          };
          break;
      }

      pipelineChart = new Chart(ctx, chartConfig);
    }

    // Update the original function to use the new flexible function
    function renderPipelineChart(counts) {
      const selectedType = document.getElementById('chartTypeSelector')?.value || 'bar';
      renderPipelineChartByType(counts, selectedType);
    }

    function renderKanban(data) {
      console.log('renderKanban called with data:', data);
      
      // Group leads by stage
      const leadsByStage = {};
      data.forEach(lead => {
        const stage = lead.stage || 'new';
        if (!leadsByStage[stage]) {
          leadsByStage[stage] = [];
        }
        leadsByStage[stage].push(lead);
      });
      
      console.log('Leads grouped by stage:', leadsByStage);

      // Update each column
      const stages = ['new', 'contacted', 'qualified', 'opportunity', 'closed_won', 'closed_lost'];
      
      stages.forEach(stage => {
        const leads = leadsByStage[stage] || [];
        const countElement = $(`${stage}-count`);
        const leadsElement = $(`${stage}-leads`);
        
        if (countElement) countElement.textContent = leads.length;
        
        if (leadsElement) {
          console.log(`Rendering ${leads.length} leads for stage ${stage}`);
          const cardsHTML = leads.map(lead => {
            const score = lead.score || 0;
            let badgeClass = 'badge-cold';
            if (score >= 75) badgeClass = 'badge-hot';
            else if (score >= 50) badgeClass = 'badge-warm';
            if (lead.classification === 'vip_client') badgeClass = 'badge-vip';

            // Get available actions based on current stage
            const availableActions = getAvailableActions(lead.stage);

            return `
              <div class="lead-card" 
                   id="lead-${lead.id}" 
                   draggable="true"
                   data-lead-id="${lead.id}"
                   data-stage="${lead.stage}"
                   onclick="openLeadModal(${JSON.stringify(lead).replace(/"/g, '&quot;')})"
                   ondragstart="handleDragStart(event)"
                   ondragend="handleDragEnd(event)">
                <div class="lead-name">${lead.name || 'Unknown'}</div>
                <div class="lead-vehicle">${lead.interest || 'Vehicle N/A'}</div>
                <div class="lead-badges">
                  <span class="badge ${badgeClass}">${(lead.classification || '').replace('_', ' ').toUpperCase()}</span>
                  <span class="badge" style="background:#f3f4f6;color:#6b7280;">${score}</span>
                </div>
                <div class="lead-actions" onclick="event.stopPropagation()">
                  ${availableActions.map(action => `
                    <button class="action-btn ${action.class}" onclick="performSalesAction(${lead.id}, '${action.action}', '${lead.name}')">
                      ${action.label}
                    </button>
                  `).join('')}
                </div>
              </div>
            `;
          }).join('');
          
          console.log(`Setting innerHTML for ${stage}:`, cardsHTML);
          leadsElement.innerHTML = cardsHTML;
        }
      });
      
      // Re-initialize drag and drop after rendering new cards
      setTimeout(() => {
        initializeDragAndDrop();
      }, 100);
    }

    function getAvailableActions(currentStage) {
      const actionMap = {
        'new': [
          { action: 'hold', label: 'Hold', class: 'hold' },
          { action: 'qualify', label: 'Qualify', class: 'qualify' }
        ],
        'contacted': [
          { action: 'qualify', label: 'Qualify', class: 'qualify' },
          { action: 'opportunity', label: 'Opportunity', class: 'opportunity' },
          { action: 'close_lost', label: 'Close Lost', class: 'close-lost' }
        ],
        'qualified': [
          { action: 'opportunity', label: 'Opportunity', class: 'opportunity' },
          { action: 'close_won', label: 'Close Won', class: 'close-won' },
          { action: 'close_lost', label: 'Close Lost', class: 'close-lost' }
        ],
        'opportunity': [
          { action: 'close_won', label: 'Close Won', class: 'close-won' },
          { action: 'close_lost', label: 'Close Lost', class: 'close-lost' }
        ],
        'closed_won': [
          { action: 'reopen', label: 'Reopen', class: 'qualify' }
        ],
        'closed_lost': [
          { action: 'reopen', label: 'Reopen', class: 'qualify' }
        ]
      };
      
      return actionMap[currentStage] || [];
    }

    async function performSalesAction(leadId, action, leadName) {
      const notes = prompt(`Add notes for ${action} action for ${leadName}:`, '');
      if (notes === null) return; // User cancelled
      
      try {
        const base = $('baseUrl').value.trim().replace(/\/$/, '');
        const token = $('token').value.trim();
        
        const response = await fetch(`${base}/api/leads/${leadId}/actions`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: action,
            notes: notes
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          alert(`✅ Successfully ${action} for ${leadName}`);
          // Refresh the dashboard to show updated data
          loadDashboard();
        } else {
          const error = await response.json();
          alert(`❌ Error: ${error.error}`);
        }
      } catch (error) {
        alert(`❌ Network error: ${error.message}`);
      }
    }

    // Modal Functions
    function openLeadModal(lead) {
      const modal = $('leadModal');
      const modalTitle = $('modalTitle');
      const modalBody = $('modalBody');

      modalTitle.textContent = `${lead.name || 'Unknown Lead'}`;

      const details = `
        <div class="lead-detail-section">
          <h3>Basic Information</h3>
          <div class="detail-row">
            <div class="detail-label">Name:</div>
            <div class="detail-value">${lead.name || 'N/A'}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Phone:</div>
            <div class="detail-value">${lead.phone || 'N/A'}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Email:</div>
            <div class="detail-value">${lead.email || 'N/A'}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Source:</div>
            <div class="detail-value">${lead.source || 'N/A'}</div>
          </div>
        </div>
        
        <div class="lead-detail-section">
          <h3>Vehicle Interest</h3>
          <div class="detail-row">
            <div class="detail-label">Interest:</div>
            <div class="detail-value">${lead.interest || 'N/A'}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Budget Range:</div>
            <div class="detail-value">${lead.budget_range || 'N/A'}</div>
          </div>
        </div>
        
        <div class="lead-detail-section">
          <h3>Lead Status</h3>
          <div class="detail-row">
            <div class="detail-label">Stage:</div>
            <div class="detail-value">${(lead.stage || '').replace('_', ' ').toUpperCase()}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Classification:</div>
            <div class="detail-value">${(lead.classification || '').replace('_', ' ').toUpperCase()}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Score:</div>
            <div class="detail-value">${lead.score || 0}/100</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Existing Customer:</div>
            <div class="detail-value">${lead.existing_customer ? 'Yes' : 'No'}</div>
          </div>
        </div>
      `;

      modalBody.innerHTML = details;
      modal.style.display = 'block';
    }

    // Drag and Drop Functions
    let draggedElement = null;

    function handleDragStart(event) {
      draggedElement = event.target;
      event.target.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/html', event.target.outerHTML);
    }

    function handleDragEnd(event) {
      event.target.classList.remove('dragging');
      draggedElement = null;
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(event) {
      if (event.target.classList.contains('kanban-column') || event.target.closest('.kanban-column')) {
        const column = event.target.classList.contains('kanban-column') ? event.target : event.target.closest('.kanban-column');
        column.classList.add('drag-over');
      }
    }

    function handleDragLeave(event) {
      if (event.target.classList.contains('kanban-column')) {
        event.target.classList.remove('drag-over');
      }
    }

    async function handleDrop(event) {
      event.preventDefault();
      
      const column = event.target.classList.contains('kanban-column') ? event.target : event.target.closest('.kanban-column');
      if (!column || !draggedElement) return;
      
      column.classList.remove('drag-over');
      
      const leadId = draggedElement.getAttribute('data-lead-id');
      const currentStage = draggedElement.getAttribute('data-stage');
      const newStage = column.getAttribute('data-stage');
      
      if (currentStage === newStage) return; // No change needed
      
      try {
        const base = $('baseUrl').value.trim().replace(/\/$/, '');
        const token = $('token').value.trim();
        
        const response = await fetch(`${base}/api/leads/${leadId}/stage`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            stage: newStage,
            action: `drag_drop_${currentStage}_to_${newStage}`
          })
        });
        
        if (response.ok) {
          // Refresh the dashboard to show updated data
          loadDashboard();
        } else {
          const error = await response.json();
          alert(`❌ Error moving lead: ${error.error}`);
        }
      } catch (error) {
        alert(`❌ Network error: ${error.message}`);
      }
    }

    // Initialize drag and drop for kanban columns
    function initializeDragAndDrop() {
      const columns = document.querySelectorAll('.kanban-column');
      columns.forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('dragenter', handleDragEnter);
        column.addEventListener('dragleave', handleDragLeave);
        column.addEventListener('drop', handleDrop);
      });
    }

    async function loadDashboard() {
      const btn = $('btnText');
      btn.textContent = 'Loading...';

      try {
        const [metrics, kanban] = await Promise.all([
          fetchJSON('/api/metrics'),
          fetchJSON('/api/kanban')
        ]);

        // Store leads data for filtering
        allLeadsData = kanban;
        filteredLeadsData = [...kanban];

        renderMetrics(metrics);
        renderKanban(filteredLeadsData);

        btn.textContent = 'Refresh';

      } catch (err) {
        console.error('Dashboard load error:', err);
        btn.textContent = 'Error';
        
        // Show error in metrics
        $('mTotal').innerText = 'Error';
        $('mHot').innerText = 'Error';
        $('mConv').innerText = 'Error';
        $('mRev').innerText = 'Error';
        
        alert('Error loading dashboard: ' + err.message);
      }
    }

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize modal close functionality
      const modal = $('leadModal');
      const closeBtn = document.querySelector('.close');
      
      if (closeBtn) {
        closeBtn.onclick = function() {
          modal.style.display = 'none';
        }
      }
      
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      }
      
      // Initialize theme, search, and other functionality
      initializeTheme();
      initializeSearchAndFilter();
      
      // Initialize drag and drop after a short delay to ensure elements are rendered
      setTimeout(() => {
        initializeDragAndDrop();
        loadDashboard();
      }, 500);
    });
  </script>
</body>
</html>
