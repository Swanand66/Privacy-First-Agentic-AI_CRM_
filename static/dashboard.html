<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luxury Automotive CRM • Executive Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #fafbfc;
      color: #1a1a1a;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.5;
      font-size: 14px;
    }

    /* Header */
    .header {
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .brand {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
      letter-spacing: -0.025em;
    }

    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .header-controls input {
      padding: 8px 12px;
      background: #ffffff;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      color: #374151;
      font-size: 14px;
      transition: border-color 0.2s;
      min-width: 200px;
    }

    .header-controls input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .refresh-btn {
      padding: 8px 16px;
      background: #3b82f6;
      border: none;
      border-radius: 6px;
      color: #ffffff;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 14px;
    }

    .refresh-btn:hover {
      background: #2563eb;
    }

    /* Container */
    .container {
      padding: 24px 32px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .metric-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 24px;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .metric-card:hover {
      border-color: #d1d5db;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .metric-label {
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #6b7280;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .metric-icon {
      font-size: 16px;
      color: #9ca3af;
    }

    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
      line-height: 1;
    }

    .metric-change {
      font-size: 13px;
      font-weight: 500;
      color: #059669;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: #ecfdf5;
      border-radius: 4px;
    }

    .metric-change.negative {
      color: #dc2626;
      background: #fef2f2;
    }

    /* Main Grid */
    .main-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    /* Panel */
    .panel {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f3f4f6;
    }

    .panel-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
    }

    .panel-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
    }

    /* Circular Progress */
    .circular-progress-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 20px;
    }

    .circular-progress {
      position: relative;
      width: 140px;
      height: 140px;
    }

    .circular-progress svg {
      transform: rotate(-90deg);
    }

    .circular-progress circle {
      fill: none;
      stroke-width: 8;
      stroke-linecap: round;
    }

    .circle-bg {
      stroke: #f3f4f6;
    }

    .circle-progress {
      stroke: #3b82f6;
      stroke-dasharray: 440;
      stroke-dashoffset: 440;
      transition: stroke-dashoffset 1s ease-out;
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .progress-value {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }

    .progress-label {
      font-size: 12px;
      color: #6b7280;
    }

    /* Status Indicators */
    .status-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .status-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: #f9fafb;
      border-radius: 6px;
      border-left: 3px solid transparent;
      transition: all 0.2s;
    }

    .status-item:hover {
      background: #f3f4f6;
      border-left-color: #3b82f6;
    }

    .status-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      color: #374151;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-percent {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    /* Kanban */
    .kanban-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
      margin-top: 20px;
    }

    .kanban-column {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      min-height: 400px;
      transition: all 0.2s;
    }

    .kanban-column:hover {
      border-color: #d1d5db;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .kanban-header {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #6b7280;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .kanban-count {
      background: #e5e7eb;
      color: #374151;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }

    .lead-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .lead-card:hover {
      border-color: #d1d5db;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    .lead-name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
      color: #111827;
    }

    .lead-vehicle {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .lead-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-hot {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .badge-warm {
      background: #fffbeb;
      color: #d97706;
      border: 1px solid #fed7aa;
    }

    .badge-cold {
      background: #eff6ff;
      color: #2563eb;
      border: 1px solid #bfdbfe;
    }

    .badge-vip {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    /* Vehicle Types Panel */
    .vehicle-types {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .vehicle-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .vehicle-item:hover {
      background: #f3f4f6;
    }

    .vehicle-icon {
      font-size: 20px;
      width: 40px;
      text-align: center;
      color: #6b7280;
    }

    .vehicle-info {
      flex: 1;
    }

    .vehicle-name {
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
      font-size: 14px;
    }

    .vehicle-bar {
      height: 4px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }

    .vehicle-fill {
      height: 100%;
      background: #3b82f6;
      border-radius: 4px;
      transition: width 1s ease-out;
    }

    .vehicle-percent {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      min-width: 50px;
      text-align: right;
    }

    /* Responsive */
    @media (max-width: 1400px) {
      .main-grid { grid-template-columns: 1fr; }
      .kanban-grid { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 768px) {
      .kanban-grid { grid-template-columns: repeat(2, 1fr); }
      .metrics-grid { grid-template-columns: 1fr; }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      margin: 5% auto;
      padding: 0;
      border: 1px solid #444;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      background: linear-gradient(135deg, #1d4ed8, #3b82f6);
      padding: 20px;
      border-radius: 16px 16px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      color: white;
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }

    .close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .close:hover {
      opacity: 0.7;
    }

    .modal-body {
      padding: 30px;
      color: #e0e0e0;
    }

    .lead-detail-section {
      margin-bottom: 25px;
    }

    .lead-detail-section h3 {
      background: linear-gradient(135deg, #3b82f6, #ffffff);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 15px;
      font-size: 18px;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 8px;
    }

    .detail-row {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 15px;
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    .detail-label {
      font-weight: 600;
      color: #a0a0a0;
    }

    .detail-value {
      color: #ffffff;
    }

    .badge-large {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      margin: 5px 5px 5px 0;
    }

    .badge-hot { background: linear-gradient(135deg, #ff6b6b, #ee5a52); color: white; }
    .badge-vip { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: #ffffff; }
    .badge-cold { background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; }
    .badge-warm { background: linear-gradient(135deg, #fd79a8, #e84393); color: white; }

    .score-display {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(135deg, #3b82f6, #ffffff);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="brand">Luxury Automotive CRM</div>
    <div class="header-controls">
      <input id="baseUrl" value="http://localhost:5000" placeholder="API URL" />
      <input id="token" type="password" placeholder="Bearer Token" value="AJoIgBPsxE2_t6Mi7L7DOOTxuWo3iEjFe8QmP2rQ3xU" />
      <button class="refresh-btn" onclick="loadDashboard()">
        <span id="btnText">Refresh</span>
      </button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    
    <!-- Hero Metrics -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">
          Total Leads
        </div>
        <div class="metric-value" id="mTotal">–</div>
        <div class="metric-change">
          <span>↗</span>
          <span>+12.5% vs last month</span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-label">
          Hot Leads
        </div>
        <div class="metric-value" id="mHot">–</div>
        <div class="metric-change">
          <span>•</span>
          <span>Urgent Action Required</span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-label">
          Conversion Rate
        </div>
        <div class="metric-value" id="mConv">–</div>
        <div class="metric-change">
          <span>↗</span>
          <span>Target: 25.0%</span>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-label">
          Pipeline Value
        </div>
        <div class="metric-value" id="mRev">–</div>
        <div class="metric-change">
          <span>₹</span>
          <span>INR Forecast</span>
        </div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
      <!-- Pipeline Chart -->
      <div class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Sales Pipeline Distribution</div>
            <div class="panel-subtitle">Lead flow across conversion stages</div>
          </div>
        </div>
        <canvas id="pipelineChart" style="max-height: 300px;"></canvas>
      </div>

      <!-- Circular Progress -->
      <div class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Lead Quality Score</div>
            <div class="panel-subtitle">Hot vs Total Leads</div>
          </div>
        </div>
        <div class="circular-progress-container">
          <div class="circular-progress">
            <svg width="140" height="140">
              <defs>
                <linearGradient id="blueGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#1d4ed8;stop-opacity:1" />
                </linearGradient>
              </defs>
              <circle class="circle-bg" cx="70" cy="70" r="60"></circle>
              <circle class="circle-progress" cx="70" cy="70" r="60" id="hotCircle"></circle>
            </svg>
            <div class="progress-text">
              <div class="progress-value" id="hotPercent">–</div>
              <div class="progress-label">Hot Leads</div>
            </div>
          </div>

          <div class="status-list" style="width: 100%;">
            <div class="status-item">
              <div class="status-label">
                <div class="status-dot" style="background: #10B981;"></div>
                <span>Qualified</span>
              </div>
              <span class="status-percent" id="qualifiedCount">–</span>
            </div>
            <div class="status-item">
              <div class="status-label">
                <div class="status-dot" style="background: #3b82f6;"></div>
                <span>Opportunity</span>
              </div>
              <span class="status-percent" id="opportunityCount">–</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Vehicle Types -->
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Luxury Vehicle Portfolio</div>
          <div class="panel-subtitle">Interest distribution by vehicle type</div>
        </div>
      </div>
      <div class="vehicle-types" id="vehicleTypes">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Kanban Board -->
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Executive Pipeline View</div>
          <div class="panel-subtitle">Rolls-Royce, Bentley & Ultra-Luxury Opportunities</div>
        </div>
      </div>
      <div class="kanban-grid" id="kanban"></div>
    </div>

  </div>

  <!-- Lead Detail Modal -->
  <div id="leadModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Lead Details</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Lead details will be populated here -->
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // Generate Stars
    const starsContainer = document.getElementById('stars');
    for (let i = 0; i < 200; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.width = star.style.height = Math.random() * 3 + 'px';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = Math.random() * 3 + 's';
      starsContainer.appendChild(star);
    }

    const $ = (id) => document.getElementById(id);

    async function fetchJSON(path) {
      const base = $('baseUrl').value.trim().replace(/\/$/, '');
      const token = $('token').value.trim();
      const res = await fetch(base + path, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    function formatINR(n) {
      if (n >= 10000000) return '₹' + (n / 10000000).toFixed(1) + ' Cr';
      if (n >= 100000) return '₹' + (n / 100000).toFixed(1) + ' L';
      return '₹' + Math.round(n).toLocaleString('en-IN');
    }

    let pipelineChart;

    function renderMetrics(data) {
      console.log('renderMetrics called with:', data);
      const stats = data.stats || {};
      const counts = data.pipeline_counts || {};
      const forecast = data.forecast_revenue || {};

      console.log('Stats:', stats);
      console.log('Counts:', counts);
      console.log('Forecast:', forecast);

      console.log('mTotal element:', $('mTotal'));
      console.log('mHot element:', $('mHot'));
      
      $('mTotal').innerText = stats.total_leads || 0;
      $('mHot').innerText = stats.classification_counts?.hot_lead || 0;
      
      // Use conversion rate from backend (won / (won + lost))
      $('mConv').innerText = (stats.conversion_rate || 0) + '%';
      
      // Use pipeline_value from backend and format as crores
      const pipelineValue = stats.pipeline_value || 0;
      $('mRev').innerText = pipelineValue > 0 ? `₹${pipelineValue} Crores` : '₹0';

      // Hot Lead Percentage
      const hotLeads = stats.classification_counts?.hot_lead || 0;
      const hotPercent = stats.total_leads > 0 
        ? Math.round((hotLeads / stats.total_leads) * 100)
        : 0;
      $('hotPercent').innerText = hotPercent + '%';
      
      console.log('Updated metrics:', {
        total: $('mTotal').innerText,
        hot: $('mHot').innerText,
        conversion: $('mConv').innerText,
        revenue: $('mRev').innerText,
        hotPercent: $('hotPercent').innerText
      });
      
      // Animate circle
      const circle = $('hotCircle');
      const circumference = 2 * Math.PI * 70;
      const offset = circumference - (hotPercent / 100) * circumference;
      circle.style.strokeDashoffset = offset;

      $('qualifiedCount').innerText = counts.qualified || 0;
      $('opportunityCount').innerText = counts.opportunity || 0;

      // Pipeline Chart
      const labels = ['New', 'Contacted', 'Qualified', 'Opportunity', 'Won', 'Lost'];
      const values = ['new','contacted','qualified','opportunity','closed_won','closed_lost']
        .map(s => counts[s] || 0);

      if (pipelineChart) pipelineChart.destroy();
      pipelineChart = new Chart($('pipelineChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: [
              'rgba(100,100,100,0.6)',
              'rgba(59,130,246,0.6)',
              'rgba(16,185,129,0.6)',
              'rgba(255,215,0,0.8)',
              'rgba(34,197,94,0.8)',
              'rgba(239,68,68,0.6)'
            ],
            borderColor: [
              'rgba(150,150,150,1)',
              'rgba(59,130,246,1)',
              'rgba(16,185,129,1)',
              'rgba(255,215,0,1)',
              'rgba(34,197,94,1)',
              'rgba(239,68,68,1)'
            ],
            borderWidth: 2,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.9)',
              titleColor: '#3b82f6',
              bodyColor: '#FFF',
              borderColor: '#3b82f6',
              borderWidth: 1,
              padding: 12
            }
          },
          scales: {
            x: { 
              grid: { display: false, color: 'rgba(255,255,255,0.1)' },
              ticks: { color: 'rgba(255,255,255,0.6)' }
            },
            y: { 
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: 'rgba(255,255,255,0.6)', precision: 0 }
            }
          }
        }
      });

      // Vehicle Types
      const vehicles = {
        'Rolls-Royce': 45,
        'Bentley': 30,
        'Ferrari': 15,
        'Lamborghini': 10
      };
      const vehicleIcons = ['🏛️', '🎩', '🏎️', '⚡'];
      const container = $('vehicleTypes');
      container.innerHTML = '';
      Object.entries(vehicles).forEach(([name, percent], i) => {
        const icon = vehicleIcons[i] || '🚗';
        container.innerHTML += `
          <div class="vehicle-item">
            <div class="vehicle-icon">${icon}</div>
            <div class="vehicle-info">
              <div class="vehicle-name">${name}</div>
              <div class="vehicle-bar">
                <div class="vehicle-fill" style="width: ${percent}%;"></div>
              </div>
            </div>
            <div class="vehicle-percent">${percent}%</div>
          </div>
        `;
      });
    }

    function renderKanban(data) {
      console.log('renderKanban called with:', data);
      const container = $('kanban');
      container.innerHTML = '';

      const stages = [
        { key: 'new', label: 'NEW' },
        { key: 'contacted', label: 'CONTACTED' },
        { key: 'qualified', label: 'QUALIFIED' },
        { key: 'opportunity', label: 'OPPORTUNITY' },
        { key: 'closed_won', label: 'WON' },
        { key: 'closed_lost', label: 'LOST' }
      ];

      // Group leads by stage
      const leadsByStage = {};
      data.forEach(lead => {
        const stage = lead.stage || 'new';
        if (!leadsByStage[stage]) {
          leadsByStage[stage] = [];
        }
        leadsByStage[stage].push(lead);
      });
      
      console.log('Leads grouped by stage:', leadsByStage);

      stages.forEach(stage => {
        const leads = leadsByStage[stage.key] || [];
        const col = document.createElement('div');
        col.className = 'kanban-column';
        col.innerHTML = `
          <div class="kanban-header">
            <span>${stage.icon} ${stage.label}</span>
            <span class="kanban-count">${leads.length}</span>
          </div>
        `;

        leads.forEach(lead => {
          const score = lead.score || 0;
          let badgeClass = 'badge-cold';
          if (score >= 75) badgeClass = 'badge-hot';
          else if (score >= 50) badgeClass = 'badge-warm';
          if (lead.classification === 'vip_client') badgeClass = 'badge-vip';

          const card = document.createElement('div');
          card.className = 'lead-card';
          card.innerHTML = `
            <div class="lead-name">${lead.name || 'Unknown'}</div>
            <div class="lead-vehicle">${lead.interest || 'Vehicle N/A'}</div>
            <div class="lead-badges">
              <span class="badge ${badgeClass}">${(lead.classification || '').replace('_', ' ').toUpperCase()}</span>
              <span class="badge" style="background:rgba(255,255,255,0.1);">${score}</span>
            </div>
          `;
          
          // Add click functionality
          card.addEventListener('click', () => showLeadDetails(lead));
          
          col.appendChild(card);
        });

        container.appendChild(col);
      });
    }

    async function loadDashboard() {
      const btn = $('btnText');
      btn.textContent = 'Loading...';

      try {
        console.log('Fetching dashboard data...');
        console.log('Base URL:', $('baseUrl').value);
        console.log('Token:', $('token').value ? 'Present' : 'Missing');
        
        const [metrics, kanban] = await Promise.all([
          fetchJSON('/api/metrics'),
          fetchJSON('/api/kanban')
        ]);

        console.log('Metrics:', metrics);
        console.log('Kanban:', kanban);

        renderMetrics(metrics);
        renderKanban(kanban);

        btn.textContent = '✓ Loaded';

      } catch (err) {
        console.error('Dashboard load error:', err);
        console.error('Error details:', err);
        alert('Error loading dashboard: ' + err.message);
        btn.textContent = '❌ Error';
      }
    }

    // Enhanced debugging for modal functionality
    function showLeadDetails(lead) {
      console.log('showLeadDetails called with:', lead);
      const modal = document.getElementById('leadModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');

      if (!modal || !modalTitle || !modalBody) {
          console.error('Modal elements not found!');
          return;
      }

      modalTitle.textContent = `${lead.name || 'Unknown Lead'}`;

      const details = `
        <div class="lead-detail-section">
          <h3>📋 Basic Information</h3>
          <div class="detail-row">
            <div class="detail-label">Name:</div>
            <div class="detail-value">${lead.name || 'N/A'}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Phone:</div>
            <div class="detail-value">${lead.phone || 'N/A'}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Email:</div>
            <div class="detail-value">${lead.email || 'N/A'}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Source:</div>
            <div class="detail-value">${lead.source || 'N/A'}</div>
          </div>
        </div>
      `;

      modalBody.innerHTML = details;
      modal.style.display = 'block';
      console.log('Modal displayed successfully!');
    }

    // Ensure event listeners are properly attached
    console.log('Attaching click event listeners to lead cards...');
    document.querySelectorAll('.lead-card').forEach(card => {
        card.addEventListener('click', () => {
            const leadName = card.querySelector('.lead-name').innerText;
            console.log(`Lead card clicked: ${leadName}`);
            const lead = {
                name: leadName,
                phone: 'N/A',
                email: 'N/A',
                source: 'N/A'
            };
            showLeadDetails(lead);
        });
    });

    // Close modal functionality and auto-load dashboard
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('leadModal');
      const closeBtn = document.querySelector('.close');
      
      closeBtn.onclick = function() {
        modal.style.display = 'none';
      }
      
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      }
      
      // Auto-load dashboard data when page loads
      console.log('DOM loaded, starting dashboard load...');
      console.log('Testing $ function:', $('mTotal'));
      
      // Set initial values to show something
      $('mTotal').innerText = 'Loading...';
      $('mHot').innerText = 'Loading...';
      $('mConv').innerText = 'Loading...';
      $('mRev').innerText = 'Loading...';
      
      // Load dashboard data
      setTimeout(() => {
        loadDashboard();
      }, 1000);
    });

    // Debugging lead card click functionality
    console.log('Adding click event listeners to lead cards...');

    document.querySelectorAll('.lead-card').forEach(card => {
        card.addEventListener('click', () => {
            const leadName = card.querySelector('.lead-name').innerText;
            console.log(`Lead card clicked: ${leadName}`);
        });
    });
  </script>
</body>
</html>
