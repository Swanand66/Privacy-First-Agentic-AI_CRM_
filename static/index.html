<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workflow Orchestrator</title>
  <style>
    :root {
      --bg-primary: #0f1419;
      --bg-secondary: #1a1f3a; 
      --bg-tertiary: #0a0e27;
      --panel-bg: rgba(255, 255, 255, 0.05);
      --panel-border: rgba(255, 255, 255, 0.1);
      --text-primary: #ffffff;
      --text-secondary: #fbfbfb;
      --text-muted: #9ca3af;
      --brand-primary: #3b82f6;
      --brand-secondary: #1d4ed8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body { 
      margin: 0; 
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
      color: var(--text-primary); 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
    }
    
    header { 
      position: sticky; 
      top: 0; 
      z-index: 100; 
      display: flex; 
      gap: 16px; 
      align-items: center; 
      padding: 20px 24px; 
      background: rgba(15, 20, 25, 0.95);
      border-bottom: 1px solid var(--panel-border); 
      backdrop-filter: blur(20px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    header .brand { 
      font-weight: 800; 
      font-size: 20px;
      letter-spacing: 0.5px;
      background: linear-gradient(135deg, var(--brand-primary), var(--text-primary), var(--brand-secondary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    header input { 
      padding: 12px 16px; 
      border-radius: 12px; 
      border: 1px solid var(--panel-border); 
      background: var(--panel-bg); 
      color: var(--text-primary);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    header input:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    
    header button { 
      background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); 
      color: white; 
      border: 0; 
      padding: 12px 20px; 
      border-radius: 12px; 
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    header button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .container { 
      padding: 24px; 
      max-width: 1400px; 
      margin: 0 auto; 
    }
    
    .grid { 
      display: grid; 
      grid-template-columns: 1.4fr 1fr; 
      gap: 24px; 
    }
    
    .card { 
      background: var(--panel-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--panel-border); 
      border-radius: 20px; 
      padding: 24px; 
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
    }
    
    .card h3 { 
      margin: 0 0 16px; 
      font-size: 20px; 
      font-weight: 700;
      color: var(--text-primary);
    }
    
    label { 
      display: block; 
      margin: 12px 0 8px; 
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    input, select { 
      width: 100%; 
      padding: 12px 16px; 
      border-radius: 12px; 
      border: 1px solid var(--panel-border); 
      background: var(--panel-bg); 
      color: var(--text-primary);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    
    select option {
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 8px;
    }
    
    .row { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 16px; 
    }
    
    .actions { 
      display: flex; 
      gap: 12px; 
      flex-wrap: wrap; 
      margin-top: 20px;
    }
    
    .btn { 
      background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary)); 
      color: white; 
      border: 0; 
      padding: 12px 20px; 
      border-radius: 12px; 
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }
    
    .btn.gray { 
      background: linear-gradient(135deg, #374151, #1f2937);
      box-shadow: 0 4px 12px rgba(55, 65, 81, 0.3);
    }
    
    .btn.gray:hover {
      box-shadow: 0 6px 20px rgba(55, 65, 81, 0.4);
    }

    .timeline { 
      list-style: none; 
      padding: 0; 
      margin: 0; 
    }
    
    .timeline li { 
      display: grid; 
      grid-template-columns: 32px 1fr; 
      gap: 16px; 
      padding: 16px 0; 
      border-bottom: 1px solid var(--panel-border);
    }
    
    .timeline li:last-child {
      border-bottom: none;
    }
    
    .dot { 
      width: 12px; 
      height: 12px; 
      margin-top: 6px; 
      border-radius: 50%; 
      background: var(--text-muted);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .dot.ok { 
      background: var(--success);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    .dot.warn { 
      background: var(--warning);
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    
    .dot.err { 
      background: var(--danger);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    
    pre { 
      background: var(--panel-bg);
      border: 1px solid var(--panel-border); 
      border-radius: 16px; 
      padding: 20px; 
      overflow: auto;
      backdrop-filter: blur(10px);
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">Workflow Orchestrator</div>
    <input id="baseUrl" value="http://localhost:5000" />
    <input id="token" placeholder="Bearer token" />
    <button id="useTest">Use Test</button>
  </header>

  <div class="container">
    <div class="grid">
      <div class="card">
        <h3>Lead Details</h3>
        <div class="row">
          <div>
            <label>Trigger</label>
            <select id="trigger">
              <option value="new_lead">new_lead</option>
              <option value="follow_up">follow_up</option>
              <option value="quotation_request">quotation_request</option>
              <option value="deal_closing">deal_closing</option>
            </select>
          </div>
          <div>
            <label>Source</label>
            <select id="source">
              <option value="website_form">website_form</option>
              <option value="phone_call">phone_call</option>
              <option value="walk_in">walk_in</option>
              <option value="referral">referral</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Name</label>
            <input id="name" value="Rajesh Sharma" />
          </div>
          <div>
            <label>Phone (+91...)</label>
            <input id="phone" value="+919876543210" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Email</label>
            <input id="email" value="rajesh@example.com" />
          </div>
          <div>
            <label>Vehicle Interest</label>
            <input id="interest" value="Rolls-Royce Phantom" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Budget Range</label>
            <input id="budget" value="8-10 crore" />
          </div>
          <div>
            <label>Existing Customer</label>
            <select id="existing">
              <option value="false">false</option>
              <option value="true">true</option>
            </select>
          </div>
        </div>

        <div class="actions" style="margin-top:12px;">
          <button class="btn" id="runBtn">Run Workflow</button>
          <button class="btn gray" id="testBtn">Run Test</button>
          <button class="btn gray" id="voiceBtn">Place Call</button>
        </div>
      </div>

      <div class="card">
        <h3>Agent Timeline</h3>
        <ul class="timeline" id="timeline"></ul>
        <h3 style="margin-top:12px;">Raw Response</h3>
        <pre id="out">No response yet</pre>
      </div>
    </div>
  </div>

  <script>
    const el = (id) => document.getElementById(id);
    const show = (obj) => { el('out').textContent = JSON.stringify(obj, null, 2); };

    function timelineItem(agent, action, status, ts, details) {
      const li = document.createElement('li');
      const dot = document.createElement('div');
      dot.className = 'dot ' + (status === 'executed' || status === 'scheduled' ? 'ok' : (status === 'pending' ? 'warn' : 'err'));
      const body = document.createElement('div');
      const title = document.createElement('div');
      title.innerHTML = `<strong>${agent}</strong> â€¢ ${action} <span style="color:#a7b0c0;">(${status})</span>`;
      const time = document.createElement('div'); time.style.color = '#a7b0c0'; time.style.fontSize = '12px'; time.textContent = ts;
      body.appendChild(title); body.appendChild(time);
      li.appendChild(dot); li.appendChild(body);
      return li;
    }

    function renderTimeline(events) {
      const ul = el('timeline'); ul.innerHTML = '';
      (events || []).forEach(ev => ul.appendChild(timelineItem(ev.agent, ev.action, ev.status, ev.timestamp, ev.details)));
    }

    async function callApi(path, payload) {
      const base = el('baseUrl').value.trim().replace(/\/$/, '');
      const token = el('token').value.trim();
      const res = await fetch(base + path, { method: 'POST', headers: { 'Content-Type':'application/json','Authorization': `Bearer ${token}` }, body: JSON.stringify(payload || {}) });
      let data; try { data = await res.json(); } catch { data = { error: 'Non-JSON', status: res.status }; }
      return { status: res.status, data };
    }

    el('runBtn').onclick = async () => {
      const payload = {
        trigger: el('trigger').value,
        lead_data: {
          name: el('name').value, phone: el('phone').value, email: el('email').value, source: el('source').value, interest: el('interest').value, budget_range: el('budget').value, existing_customer: el('existing').value === 'true'
        }
      };
      const res = await callApi('/workflow/run', payload);
      show(res.data); renderTimeline(res.data.executed_agents);
    };

    el('testBtn').onclick = async () => {
      const res = await callApi('/workflow/test', {});
      show(res.data); renderTimeline(res.data.executed_agents);
    };

    el('useTest').onclick = () => {
      el('trigger').value = 'new_lead'; el('source').value = 'website_form'; el('name').value = 'Rajesh Sharma'; el('phone').value = '+919876543210'; el('email').value = 'rajesh@example.com'; el('interest').value = 'Rolls-Royce Phantom'; el('budget').value = '8-10 crore'; el('existing').value = 'true';
    };

    el('voiceBtn').onclick = async () => {
      const payload = { to_phone: el('phone').value, variables: { lead_name: el('name').value, interest: el('interest').value } };
      const res = await callApi('/voice/call', payload);
      alert((res.data.ok ? 'Call placed: ' : 'Failed: ') + JSON.stringify(res.data.info || res.data));
    };

    // Helper to process a payload object coming from localStorage
    function processIncomingPayload(payload) {
      try {
        if (!payload) return;
        el('baseUrl').value = payload.baseUrl || el('baseUrl').value;
        el('token').value = payload.token || el('token').value;
        if (payload.leadData) {
          el('trigger').value = 'new_lead';
          el('source').value = payload.leadData.source || el('source').value;
          el('name').value = payload.leadData.name || el('name').value;
          el('phone').value = payload.leadData.phone || el('phone').value;
          el('email').value = payload.leadData.email || el('email').value;
          el('interest').value = payload.leadData.interest || el('interest').value;
          el('budget').value = payload.leadData.budget_range || el('budget').value;
          el('existing').value = (payload.leadData.existing_customer === true) ? 'true' : 'false';
        }

        if (payload.workflowResult) {
          // Render raw response and timeline if available
          show(payload.workflowResult);
          if (payload.workflowResult.executed_agents) renderTimeline(payload.workflowResult.executed_agents);
        }
      } catch (e) {
        console.warn('Error processing incoming payload:', e);
      }
    }

    // Read any existing payload on load (in case the form wrote earlier)
    try {
      const raw = localStorage.getItem('incomingWorkflow');
      if (raw) {
        processIncomingPayload(JSON.parse(raw));
        localStorage.removeItem('incomingWorkflow'); // Clear after processing
        localStorage.removeItem('incomingWorkflow_ts'); // Clear timestamp
      }
    } catch (e) {
      console.warn('Failed to read and clear initial incomingWorkflow from localStorage:', e);
    }

    // Listen for changes so submissions from other tabs/windows are received
    window.addEventListener('storage', (ev) => {
      if (!ev.key) return;
      if (ev.key === 'incomingWorkflow' || ev.key === 'incomingWorkflow_ts') {
        try {
          const raw = localStorage.getItem('incomingWorkflow');
          if (!raw) return;
          const payload = JSON.parse(raw);
          processIncomingPayload(payload);
        } catch (e) {
          console.warn('Failed to handle storage event for incomingWorkflow:', e);
        }
      }
    });
  </script>
</body>
</html>
